name: Build EXE and Push to Unity Repo

on:
  push:
    branches: [ "master" ] # 請確認你的主分支是 master 而不是 main

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: 檢出 Python 程式碼
      uses: actions/checkout@v4 # 建議更新到 v4

    - name: 設定 Python
      uses: actions/setup-python@v5 # 建議更新到 v5
      with:
        python-version: '3.13'

    - name: 安裝依賴並打包
      run: |
        pip install pyinstaller
        if (Test-Path requirements.txt) { pip install -r requirements.txt }
        pyinstaller --onefile --name "SimulationTool" `
          --add-data "data;data" `
          --add-data "item_icon;item_icon" `
          --add-data "skill_icon;skill_icon" `
          --add-data "status_effect_icon;status_effect_icon" `
          simulator_gui.py

    - name: 將 EXE 推送到 Unity 儲存庫
      env:
        # 重要：這裡必須引用你在 Secrets 設定的名稱
        MY_REPO_TOKEN: ${{ secrets.SIMULATION_GITACTION }}
        # 取得原始 Commit 訊息與完整的 SHA
        SRC_MSG: ${{ github.event.head_commit.message }}
        SRC_SHA: ${{ github.sha }}
      run: |
        git config --global user.email "Im bot (CICD)"
        git config --global user.name "自動化腳本(更新模擬工具exe)"
        
        # 使用環境變數帶入 Token 進行 Clone
        git clone "https://x-access-token:${env:MY_REPO_TOKEN}@github.com/then0905/HLO_new.git" unity_repo
        
        # 確保資料夾存在
        if (!(Test-Path "unity_repo/Assets/Tools")) {
            New-Item -ItemType Directory -Force -Path "unity_repo/Assets/Tools"
        }
        
        # 複製產出的 EXE
        cp dist/SimulationTool.exe unity_repo/Assets/Tools/
        
        cd unity_repo
        
        # 處理 Commit 訊息：取得 SHA 並組合訊息
        $shortSha = $env:SRC_SHA
        # 這裡將你原本想要的標題與新的內容串接在一起
        $finalCommitMsg = "[Update] 更新 模擬工具exe (Update Simulation from Python CI)`n `n更新內容 `n$env:SRC_MSG `n (Commit: $shortSha)"
        
        git add Assets/Tools/SimulationTool.exe
        
        # 檢查是否有變動，並使用組合後的變數 $finalCommitMsg 提交
        git diff --quiet && git diff --staged --quiet || (git commit -m "$finalCommitMsg" && git push)